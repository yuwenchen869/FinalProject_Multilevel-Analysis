---
title: "Analysis of Pre and Post Intervention data in Different Communities"
author: "陳于文、李沛耘"
date: "12/21/2020"
output:
  ioslides_presentation:
    smaller: yes
    transition: faster
    widescreen: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```


```{r include=FALSE}
pacman::p_load(readxl, mlmRev, tidyverse,nlme, lme4, sjPlot, ggplot2, Rmisc, multicon, effects)
```

## Data Introduction
- SOF is a tool for screen **Frailty Status** with total 3 items, the  score range  from 0-3, higher score means more frailty
- KCL is another tool for screen **Risk of Frailty** with total 25 items, he  score range  from 0-25, higher score means more frailty
- The dataset also included demographic data such as Age, Gender, Education, Living Status...etc
- The measurement between pre and post test is **Functional Fittness**, contains 6 components

## Data Structure
```{r}
dta<- read_excel("project.xlsx", sheet=1)
dim(dta)
```
```{r}
names(dta)
```



```{r}
# data wrangling
dta <- dta %>% mutate(
		KCL_def=factor(KCL_def, levels=0:1, labels=c("No_risk", "At_Risk")), 
		activity=factor(activity, levels=0:2, labels=c("Low", "Medium", "High")),
		SOF_def=factor(SOF_def, levels = c("Robust", "Pre-frailty", "Frailty")), 
		Gender=factor(ifelse(Gender=="男", "Male", "Female")))

```


```{r}

dta$Rate<-as.numeric(dta$Rate)		
dta$WC<-as.numeric(dta$WC)
dta$HIPC<-as.numeric(dta$HIPC)
dta$STAND_30sec<-as.numeric(dta$STAND_30sec)
dta$Grip=as.numeric(dta$Grip)
dta$UpReach=as.numeric(dta$UpReach)
dta$DownReach=as.numeric(dta$DownReach)
dta$STEP_2min=as.numeric(dta$STEP_2min)
dta$WALK=as.numeric(dta$WALK)
```

```{r include=FALSE}
str(dta)
```

# Descriptive statistics
## Class by Time
```{r}
addmargins(with(dta, table(Class, Time)))

```
**Class L only got Baseline Data**

```{r}
dta<-subset(dta, Class!="L")
```
Delete Class L data


## Gender by Time
```{r}
addmargins((with(dta, table(Gender, Time))))
```

```{r}
addmargins(with(dta, table(Education, Class)))
```

## Frailty by Time
```{r}
addmargins(with(dta, table(SOF_def, Time)))
```
```{r}
a<-as.data.frame(with(dta, ftable(SOF_def,Time)))  
summary(xtabs(Freq~., a))  #Chisq 

```

## More Informations
```{r}
summarySE(dta, measurevar="Age", groupvars=c("Gender", "SOF_def","Time"), na.rm=TRUE)
```

## 
```{r}
summarySE(dta, measurevar="Grip", groupvars=c("SOF_def","Time"), na.rm=TRUE)
```

# Data Visulization
## Take Grip for Example
**Overall** difference between Before and After Intervention
```{r}
diffPlot(Grip~Time, data=dta, ylim = c(23, 26), 
         xlab="Intervention Effect", ylab="Mean Grip(kg)")
```

## Relationships between Age, Frailty and Grip strength
```{r echo=FALSE}
dta %>% na.omit() %>%
ggplot(aes(SOF_def, Age))+
  geom_boxplot(size=rel(.5))+
  geom_jitter(position = position_jitter(width = 0.1), cex = 0.8) +
  labs(x = "SOF defined Frailty Status", y = "Age distribution")+
  coord_flip()+
  theme_bw()
```


## Age by Grip
```{r echo=FALSE}
dta%>% na.omit()%>%
ggplot(aes(Age, Grip))+
  geom_point(aes(color=SOF_def))+
  stat_smooth(method="lm", se=T, size=rel(.5), color="darkblue")+
  theme_minimal()+
  theme(legend.position = c(.9, .8), 
        legend.background = element_rect(fill="white"))+
  labs(x="Age", 
       y="Grip Performance(kg)")
```

## By Gender
```{r echo=FALSE}
ggplot(dta, aes(Time, Grip)) +
 facet_grid(~Gender)+
 geom_boxplot() +
 geom_jitter(position = position_jitter(width = 0.1), cex = 0.8) +
 labs(x = "Time", y = "Grip strength")+
 theme_bw()
```

## Different Baseline of Grip gains by Different Frailty Status
```{r grip data Wide, include=FALSE}
dtag<-dta %>% select(ID, Class, Age, Grip, Time, Gender, SOF_def, KCL_def)
dtagW<-dtag %>% spread(Time, Grip) %>% mutate(gain=Intervention-Baseline)
```

```{r echo=FALSE}
dtagW %>% na.omit()%>%
  ggplot(aes(Baseline, gain, group=SOF_def, color=SOF_def))+
  geom_point(size=.7, alpha=.5)+
  geom_smooth(method=lm, se=F, size=rel(.8), alpha=.5)+
  theme_minimal()+
  labs(title="Liner Relationship for Different Baseline of Grip gains")
```


## Gain and Baseline Grip

```{r echo=FALSE}
ggplot(data=subset(dtagW, Class!="I"), 
       aes(x=reorder(Class, gain, median), 
           y=gain, 
           group=Class)) + 
 geom_point(size=rel(.5), 
            alpha=.5) + 
 geom_hline(yintercept=quantile(dtagW$gain, 
                                probs=c(.25,.75), na.rm=T), 
            linetype="dotted",
            col=2) +
 labs(y="Gain Grip", 
      x="Class ID") +
 theme_minimal() +
 theme(axis.text.x=element_text(size=rel(.5),
                                angle=0, 
                                hjust=1), 
       legend.position="NONE")
```

## Class gain grip means and CIs
```{r echo=FALSE}
ggplot(data=subset(dtagW, Class!="I"), 
       aes(x=reorder(Class, gain, mean), 
           y=gain, 
           group=Class)) + 
 stat_summary(fun.data="mean_cl_boot", size=rel(.3))+
 geom_hline(yintercept=quantile(dtagW$gain, 
                                probs=c(.25,.5,.75), na.rm=T), 
            linetype="dotted",
            col=2) +
 coord_flip()+
 labs(y="Gain Grip", 
      x="Class ID") +
 theme_minimal() +
 theme(axis.text.y=element_text(size=rel(.5),
                                angle=0, 
                                vjust=1), 
       legend.position="NONE")
```


## Different Class of Grip gains
```{r}
sdta <- dtagW %>% group_by(Class) %>% na.omit() %>%
  dplyr::summarise(gain_ave=mean(gain),
                   gain_sd2=var(gain), 
                   n=n())
m_g<-lme4::lmer(gain~(1|Class), data=dtagW)
sdta<-data.frame(Class=row.names(coef(m_g)$Class),
                 yhat=coef(m_g)$Class[,1]) %>%
  inner_join(., sdta, by="Class") %>% select(-2) %>%
  data.frame()
arrange(sdta, -gain_ave)
```
- Improvement on Grip: B>E>F>D>C>G>K>H>J

## By Gender and Class
```{r echo=FALSE}
pd<-position_dodge(.2)
dta %>% 
ggplot(aes(Time, Grip, group=Class, color=Class))+
  stat_summary(fun.y = mean, geom="line", alpha=.5, position = pd )+
  stat_summary(fun.y= mean, geom="point", alpha=.5, position=pd)+
  stat_summary(fun.data = mean_se, geom="errorbar",width=rel(.5), position = pd)+
  geom_point(alpha=.3, position = pd)+
  theme_minimal()+
  facet_grid(~Gender)+
  theme(legend.background = element_rect(fill="white"))+
  labs(x="Time", 
       y="Grip strength")
```

## By Time and Frailty Status
```{r echo=FALSE}
dta %>% na.omit() %>%
ggplot(aes(Time, Grip, group=SOF_def, col=SOF_def))+
  stat_summary(fun.y = mean, geom="line", alpha=.5,position = pd )+
  stat_summary(fun.y= mean, geom="point", alpha=.5, position=pd)+
  stat_summary(fun.data = mean_se, geom="errorbar",width=rel(.3), position = pd)+
  geom_point(alpha=.3, position = pd)+
  theme_minimal()+
  theme(legend.position = c(.9, .8), 
        legend.background = element_rect(fill="white"))+
  labs(x="Time", 
       y="Grip strength")
```


## Individuals differences
```{r echo=FALSE}
pd<-position_dodge(.1)
dta %>% na.omit() %>%
ggplot(aes(Time, Grip, group= ID, color=ID))+
  stat_summary(fun.y = mean, geom="line", alpha=.5,position = pd )+
  stat_summary(fun.y= mean, geom="point", alpha=.2, position=pd)+
  stat_summary(fun.data = mean_se, geom="errorbar",width=rel(.3), position = pd)+
  geom_point(alpha=.3, position = pd)+
  theme_minimal()+
  theme(legend.position ="none")+
  labs(x="Time", 
       y="Grip strength(kg)") 
```

# Analysis 
## Random Class Intercept
```{r}
m0<-lme4::lmer(gain~Class+(1|Class), data=dtagW)
sjPlot::tab_model(m0, show.r2=F)
```

## Models Comparison
```{r}
m1<-lmer(gain~Baseline+Class+(1|Class), data=dtagW)
m2<-lmer(gain~Baseline+Gender+Class+(1|Class), data=dtagW)
m3<-lmer(gain~Baseline+Gender+Age+Class+(1|Class), data=dtagW)
m4<-lmer(gain~Baseline+Gender*Age+Class+(1|Class), data=dtagW)
anova(m0, m1, m2, m3, m4)
```

## 
```{r}
tab_model(m2, m3)
```

## Age effect with Random Slope
```{r}
m5<-update(m3,.~(Age|Class))
m5a<-update(m3, .~(Baseline+Age|Class))
anova(m3, m5, m5a)
```
After model comparing, it seems NO need to consider random slope

##
```{r}
tab_model(m3)
```

## Interpretation
- The estimate mean of gain Grip for all **Class** is 13.84 with as variance of 5.15
- The estimate mean of gain Grip for all **Case** is 13.84 with as variance of 5.15+9.61=14.76
- On average, there is a drop of 0.25 kg on gain Grip from an increase of one kg in Baseline average Grip performance
- Male Grip performance averagely higher than Female, about 3.1kg
- And Age, there is a drop of 0.08kg on one year growth 
- After adjusting for school difference in Baseline Grip, correlation between gain scores among case attending the same class is 0.35

## Residuals
```{r}
plot(m3)
```

## Normality
```{r}
qqnorm(resid(m3))
qqline(resid(m3))
```

# Generalized Linear Models

At Frailty Risk?

## Descriptive statistics

```{r}
dtak<-dta %>% select(Class, ID,KCL_def, Age, Gender, Time, Education, Living)
dtaf <- with(dtak, ftable(Class, Time, KCL_def)) %>% as.data.frame
addmargins(with(dtak, table(Time, KCL_def)))
```


```{r}
addmargins(with(dtak, table(Gender, KCL_def)))
```

## Add Variables
```{r}
dtakW <-dtaf %>% spread(KCL_def, Freq) %>% 
  inner_join(., dtak, by=c("Time", "Class")) %>%
  mutate(Total=No_risk+At_Risk)
```


```{r}
g0<-glm(cbind(At_Risk, No_risk)~Time+Gender*Age+Education+Living, data=dtakW, 
        family=binomial(link =logit ))
g1<-glm(cbind(At_Risk, No_risk)~Time+Gender*Age+Education, data=dtakW, 
        family=binomial(link =logit ))
anova(g0, g1, test="Chisq")
```

## 
```{r}
tab_model(g1)
```

## Goodness of fit
```{r}
(g1$null.deviance - g1$deviance)/g1$null.deviance
```
```{r}
1 - pchisq(g1$deviance, g1$df.residual)
```


## Residual
```{r}
qqnorm(resid(g1))
qqline(resid(g1))
```


## Interpretation
- The Odds of after intervention being at frailty risk is between 0.32-0.41
- The Odds of Higher Education(大學、研究所) at frailty risk is respectively between 0.56-0.84 and 0.34-0.93


## Limitation
```{r echo=FALSE}
addmargins(with(dta, table(SOF_def, Time)))
```
- The dropout rate roughly calculated is (360-305)/360=15.2%
- The SOF_def group sample size is significantly different, hard to infer the effects on different Frailty Status, which is one of major research question.



